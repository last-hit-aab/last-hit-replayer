{"version":3,"sources":["../lib/utils/index.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import fs from 'fs';\nimport { Flow, Story } from 'last-hit-types';\nimport path from 'path';\nimport Environment from '../config/env';\nimport { FlowFile } from '../types';\n\nexport const inElectron = !!process.versions.electron;\n\nexport const getTempFolder = (fallbackFolder?: string): string | undefined => {\n\tif (inElectron) {\n\t\t// IMPORTANT donot move to import block, electron might not exists\n\t\tconst { app } = require('electron');\n\t\treturn app.getPath('logs');\n\t} else {\n\t\treturn fallbackFolder;\n\t}\n};\n\n/**\n * get process id\n */\nexport const getProcessId = (): string => `${process.pid}`;\n\n/**\n * rewrite log files, note only be called in CI\n */\nlet logger: Console;\nexport const getLogger = (): Console => {\n\tif (!logger) {\n\t\tconst output = fs.createWriteStream(path.join(process.cwd(), 'stdout.log'));\n\t\tconst errorOutput = fs.createWriteStream(path.join(process.cwd(), 'stderr.log'));\n\t\tlogger = new console.Console({ stdout: output, stderr: errorOutput });\n\t}\n\treturn logger;\n};\n\nexport const shorternUrl = (url: string): string => {\n\ttry {\n\t\tconst parsed = new URL(url);\n\t\tparsed.search = '';\n\t\tparsed.hash = '';\n\t\treturn parsed.href;\n\t} catch {\n\t\t// parse fail, not a valid url, return directly\n\t\treturn url;\n\t}\n};\n\n/**\n * generate flow key\n */\nexport const generateKeyByObject = (story: Story, flow: Flow): string =>\n\t`[${flow.name}@${story.name}]`;\nexport const generateKeyByString = (storyName: string, flowName: string): string =>\n\t`[${flowName}@${storyName}]`;\n\n/**\n * build flows array of given workspace\n */\nexport const findFlows = (env: Environment): FlowFile[] => {\n\tconst workspace = env.getWorkspace();\n\tconst flows = fs\n\t\t.readdirSync(workspace)\n\t\t.filter(dir => fs.statSync(path.join(workspace, dir)).isDirectory())\n\t\t.filter(dir => ![ '.scripts' ].includes(dir))\n\t\t.map(storyName => {\n\t\t\treturn fs\n\t\t\t\t.readdirSync(path.join(workspace, storyName))\n\t\t\t\t.filter(flowFilename =>\n\t\t\t\t\tfs.statSync(path.join(workspace, storyName, flowFilename)).isFile()\n\t\t\t\t)\n\t\t\t\t.filter(flowFilename => flowFilename.endsWith('.flow.json'))\n\t\t\t\t.map(flowFilename => flowFilename.replace(/^(.*)\\.flow\\.json$/, '$1'))\n\t\t\t\t.filter(\n\t\t\t\t\tflowName =>\n\t\t\t\t\t\tenv.isIncluded(storyName, flowName) && !env.isExcluded(storyName, flowName)\n\t\t\t\t)\n\t\t\t\t.map(flowName => ({ story: storyName, flow: flowName }));\n\t\t})\n\t\t.reduce((flows, array) => {\n\t\t\tflows.push(...array);\n\t\t\treturn flows;\n\t\t}, [] as FlowFile[]);\n\tconst flowMap: { [key in string]: FlowFile } = {};\n\tconst necessaryFlows = flows.map(flowFile => {\n\t\tflowMap[generateKeyByString(flowFile.story, flowFile.flow)] = flowFile;\n\t\treturn flowFile;\n\t}).reduce((necessary, flowFile) => {\n\t\tconst {\n\t\t\tsettings: { forceDepends, dataDepends = [] } = {\n\t\t\t\tforceDepends: undefined,\n\t\t\t\tdataDepends: undefined\n\t\t\t}\n\t\t} = env.readFlowFile(flowFile.story, flowFile.flow);\n\t\tif (forceDepends) {\n\t\t\tconst { story, flow } = forceDepends;\n\t\t\tconst key = generateKeyByString(story, flow);\n\t\t\tif (!flowMap[key]) {\n\t\t\t\t// not include, includes it\n\t\t\t\tconst add = { story, flow };\n\t\t\t\tnecessary.push(add);\n\t\t\t\tflowMap[key] = add;\n\t\t\t}\n\t\t}\n\t\tdataDepends.forEach(({ story, flow }) => {\n\t\t\tconst key = generateKeyByString(story, flow);\n\t\t\tif (!flowMap[key]) {\n\t\t\t\t// not include, includes it\n\t\t\t\tconst add = { story, flow };\n\t\t\t\tnecessary.push(add);\n\t\t\t\tflowMap[key] = add;\n\t\t\t}\n\t\t});\n\t\treturn necessary;\n\t}, [] as FlowFile[]);\n\treturn [ ...necessaryFlows, ...flows ];\n};\n\nconst defaultName = 'last-hit';\nlet starts: { [key in string]: number } = {};\nexport const startTime = (name: string = defaultName) => {\n\tstarts[name] = new Date().getTime();\n};\n\nexport const endTime = (name: string = defaultName) => {\n\tconst now = new Date().getTime();\n\tconst start = starts[name];\n\tif (start) {\n\t\tdelete starts[name];\n\t\treturn now - start;\n\t} else {\n\t\treturn 0;\n\t}\n};"]}