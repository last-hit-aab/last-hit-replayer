{"version":3,"sources":["../lib/config/env.ts"],"names":[],"mappings":"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","file":"env.js","sourcesContent":["import fs from 'fs';\nimport jsonfile from 'jsonfile';\nimport { Flow, Step } from 'last-hit-types';\nimport os from 'os';\nimport path from 'path';\nimport { EnvironmentOptions, IncludingFilter, IncludingFilters } from '../types';\n\ntype Wrapper = (step: Step) => Step;\ntype SimpleEnvironmentOptions = Omit<EnvironmentOptions,\n\t'parallel' | 'workspace' | 'includes' | 'child'>;\n\nclass Environment {\n\t/** environment name */\n\tprivate name: string = 'NO-ENVIRONMENT';\n\t/** workspace folder */\n\tprivate workspace: string;\n\tprivate urlReplaceRegexps: RegExp[] = [];\n\tprivate urlReplaceTos: string[] = [];\n\tprivate sleepAfterChange?: number;\n\tprivate slowAjaxTime?: number;\n\tprivate includes?: IncludingFilters;\n\tprivate parallel?: number;\n\tprivate child: boolean;\n\n\tprivate adminUrl?: string;\n\tprivate adminToken?: string;\n\tprivate adminWorkspaceId?: string | number;\n\tprivate adminTestPlanId?: string | number;\n\n\tprivate wrappers: Wrapper[];\n\n\tprivate originalOptions: EnvironmentOptions;\n\n\tconstructor(options: EnvironmentOptions) {\n\t\tthis.originalOptions = options;\n\n\t\tthis.workspace = options.workspace;\n\t\tthis.mergeFrom(options);\n\n\t\tthis.includes = options.includes;\n\n\t\tthis.parallel = this.computeParallel(options.parallel);\n\t\tthis.child = options.child || false;\n\n\t\tthis.adminUrl = options.adminUrl;\n\t\tthis.adminToken = options.adminToken;\n\t\tthis.adminWorkspaceId = options.adminWorkspaceId;\n\t\tthis.adminTestPlanId = options.adminTestPlanId;\n\n\t\tthis.wrappers = [ this.wrapUrl ];\n\t}\n\n\tgetOriginalOptions(): EnvironmentOptions {\n\t\treturn this.originalOptions;\n\t}\n\n\tmergeFrom(options: SimpleEnvironmentOptions) {\n\t\tthis.name = options.name || this.name;\n\t\tif (options.urlReplaceRegexp) {\n\t\t\tthis.urlReplaceRegexps = options.urlReplaceRegexp\n\t\t\t\t.split('&&')\n\t\t\t\t.map(text => new RegExp(text));\n\t\t\tthis.urlReplaceTos = (options.urlReplaceTo || '').split('&&');\n\t\t\tthis.urlReplaceTos.length = this.urlReplaceRegexps.length;\n\t\t\tthis.urlReplaceTos = this.urlReplaceTos.map(to => (to ? to : ''));\n\t\t} else {\n\t\t\tthis.urlReplaceRegexps = [];\n\t\t\tthis.urlReplaceTos = [];\n\t\t}\n\t\tthis.sleepAfterChange = options.sleepAfterChange || this.sleepAfterChange;\n\t\tthis.slowAjaxTime = options.slowAjaxTime || this.slowAjaxTime;\n\n\t\t// set original options\n\t\t[\n\t\t\t'name',\n\t\t\t'urlReplaceRegexp', 'urlReplaceTo',\n\t\t\t'sleepAfterChange', 'slowAjaxTime',\n\t\t\t'parallel',\n\t\t\t'adminUrl'\n\t\t].forEach(\n\t\t\tprop => (this.originalOptions[prop] = options[prop])\n\t\t);\n\t}\n\n\twrap(step: Step): Step {\n\t\treturn this.getWrappers().reduce((step, wrapper) => wrapper.call(this, step), step);\n\t}\n\n\tprivate wrapUrl(step: Step): Step {\n\t\tconst regexps = this.getUrlReplaceRegexps();\n\t\tif ((step as any).url && regexps) {\n\t\t\t(step as any).url = regexps.reduce((url, regexp, index) => {\n\t\t\t\treturn url.replace(regexp, this.getUrlReplaceTos()[index] || '');\n\t\t\t}, (step as any).url);\n\t\t}\n\t\treturn step;\n\t}\n\n\tprivate getWrappers(): Wrapper[] {\n\t\treturn this.wrappers;\n\t}\n\n\tgetName(): string {\n\t\treturn this.name;\n\t}\n\n\tgetWorkspace(): string {\n\t\treturn this.workspace;\n\t}\n\n\tgetUrlReplaceRegexps(): RegExp[] {\n\t\treturn this.urlReplaceRegexps;\n\t}\n\n\tgetUrlReplaceTos(): string[] {\n\t\treturn this.urlReplaceTos;\n\t}\n\n\tgetSleepAfterChange(): number | undefined {\n\t\treturn this.sleepAfterChange;\n\t}\n\n\tgetSlowAjaxTime(): number {\n\t\treturn this.slowAjaxTime || 500;\n\t}\n\n\tisIncluded(storyName: string, flowName: string): boolean {\n\t\treturn (\n\t\t\t// no filters, including all\n\t\t\t!this.includes ||\n\t\t\tthis.includes.some((filter: IncludingFilter): boolean => {\n\t\t\t\t// story name must match\n\t\t\t\t// no flow name appointed or flow name matched\n\t\t\t\treturn filter.story === storyName && (!filter.flow || filter.flow === flowName);\n\t\t\t})\n\t\t);\n\t}\n\n\tisExcluded(storyName: string, flowName: string): boolean {\n\t\t// TODO not supported yet, always returns false\n\t\treturn false;\n\t}\n\n\tgetParallel(): number {\n\t\treturn this.parallel || 1;\n\t}\n\n\tisOnParallel(): boolean {\n\t\treturn this.getParallel() !== 1;\n\t}\n\n\tgetAdminUrl(): string | undefined {\n\t\treturn this.adminUrl;\n\t}\n\n\tgetAdminToken(): string | undefined {\n\t\treturn this.adminToken;\n\t}\n\n\tgetAdminWorkspaceId(): string | number | undefined {\n\t\treturn this.adminWorkspaceId;\n\t}\n\n\tgetAdminTestPlanId(): string | number | undefined {\n\t\treturn this.adminTestPlanId;\n\t}\n\n\tprivate computeParallel(parallel: number = 1): number {\n\t\tparallel = Math.abs(parallel);\n\t\tif (parseInt(`${parallel}`) !== parallel) {\n\t\t\treturn Math.round(os.cpus().length * parallel);\n\t\t} else {\n\t\t\treturn parallel;\n\t\t}\n\t}\n\n\tisOnChildProcess(): boolean {\n\t\treturn this.child;\n\t}\n\n\texposeForSingleProcess(replacement: { includes: IncludingFilters }): EnvironmentOptions {\n\t\tconst options = Object.assign({}, this.originalOptions);\n\t\tdelete options.parallel;\n\t\tdelete options.workspace;\n\n\t\toptions.child = true;\n\t\tObject.keys(replacement).forEach(key => (options[key] = replacement[key]));\n\n\t\treturn options;\n\t}\n\n\texpose(): SimpleEnvironmentOptions {\n\t\tconst options = Object.assign({}, this.originalOptions);\n\t\tdelete options.parallel;\n\t\tdelete options.workspace;\n\t\tdelete options.includes;\n\t\tdelete options.child;\n\t\treturn options;\n\t}\n\n\tstatic exposeNoop(): EnvironmentOptions {\n\t\treturn {\n\t\t\t// name: 'NO-ENVIRONMENT'\n\t\t} as EnvironmentOptions;\n\t}\n\n\tisStoryExists(storyName: string): boolean {\n\t\tconst dependsStoryFolder = path.join(this.getWorkspace(), storyName);\n\t\treturn fs.existsSync(dependsStoryFolder) && fs.statSync(dependsStoryFolder).isDirectory();\n\t}\n\n\tisFlowExists(storyName: string, flowName: string): boolean {\n\t\tconst dependsStoryFolder = path.join(this.getWorkspace(), storyName);\n\t\tif (!this.isStoryExists(storyName)) {\n\t\t\treturn false;\n\t\t}\n\t\tconst dependsFlowFilename = path.join(dependsStoryFolder, `${flowName}.flow.json`);\n\t\treturn fs.existsSync(dependsFlowFilename) && fs.statSync(dependsFlowFilename).isFile();\n\t}\n\n\treadFlowFile(storyName: string, flowName: string): Flow {\n\t\tconst dependsStoryFolder = path.join(this.getWorkspace(), storyName);\n\t\tconst filename = path.join(dependsStoryFolder, `${flowName}.flow.json`);\n\t\treturn jsonfile.readFileSync(filename);\n\t}\n}\n\nexport default Environment;\n"]}