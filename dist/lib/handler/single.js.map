{"version":3,"sources":["../lib/handler/single.ts"],"names":[],"mappings":"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","file":"single.js","sourcesContent":["import fs from 'fs';\nimport jsonfile from 'jsonfile';\nimport path from 'path';\nimport Environment from '../config/env';\nimport { Coverages, FlowFile, Report } from '../types';\nimport { getLogger, getProcessId } from '../utils';\nimport { print } from './print';\nimport { handleFlow } from './single-flow';\n\nconst processId = getProcessId();\n\nconst createTemporaryFolders = async (\n\tenv: Environment\n): Promise<{\n\tresultTempFolder: string;\n\tthreadTempFolder: string;\n}> => {\n\tconst workspace = env.getWorkspace();\n\tconst resultTempFolder = path.join(workspace, '.result-temp');\n\tif (!env.isOnChildProcess()) {\n\t\t// not in child process, delete the result temp folder\n\t\tif (fs.existsSync(resultTempFolder)) {\n\t\t\tfs.rmdirSync(resultTempFolder, { recursive: true });\n\t\t}\n\t}\n\tif (!fs.existsSync(resultTempFolder)) {\n\t\tfs.mkdirSync(resultTempFolder);\n\t}\n\tconst threadTempFolder = path.join(resultTempFolder, processId);\n\tif (!fs.existsSync(threadTempFolder)) {\n\t\tfs.mkdirSync(threadTempFolder);\n\t}\n\n\tconst resultParamsTempFolder = path.join(workspace, '.result-params-temp');\n\tif (!env.isOnChildProcess()) {\n\t\t// not in child process, delete the result temp folder\n\t\tif (fs.existsSync(resultParamsTempFolder)) {\n\t\t\tfs.rmdirSync(resultParamsTempFolder, { recursive: true });\n\t\t}\n\t}\n\tif (!fs.existsSync(resultParamsTempFolder)) {\n\t\tfs.mkdirSync(resultParamsTempFolder);\n\t}\n\n\treturn {\n\t\tresultTempFolder,\n\t\tthreadTempFolder\n\t};\n};\n\nexport const doOnSingleProcess = async (flows: FlowFile[], env: Environment): Promise<void> => {\n\tconst { threadTempFolder } = await createTemporaryFolders(env);\n\tlet jammed = false;\n\n\tconst logger = getLogger();\n\tconst reports: Report[] = [];\n\tconst allCoverages: Coverages = [];\n\ttry {\n\t\tconst pendingFlows: Array<FlowFile> = flows;\n\t\tconst run = async (flows: Array<FlowFile>) => {\n\t\t\tawait flows.reduce(async (promise, flow) => {\n\t\t\t\tawait promise;\n\t\t\t\ttry {\n\t\t\t\t\tconst { report, coverages, code } = await handleFlow(flow, env);\n\t\t\t\t\tif (code === 'pending') {\n\t\t\t\t\t\tpendingFlows.push(flow);\n\t\t\t\t\t} else {\n\t\t\t\t\t\treports.push(report);\n\t\t\t\t\t\tallCoverages.push(...coverages);\n\t\t\t\t\t}\n\t\t\t\t} catch (e) {\n\t\t\t\t\tlogger.error(e);\n\t\t\t\t} finally {\n\t\t\t\t\t// do nothing\n\t\t\t\t\treturn Promise.resolve();\n\t\t\t\t}\n\t\t\t}, Promise.resolve());\n\t\t};\n\t\tconst countLeft = pendingFlows.length;\n\t\twhile (pendingFlows.length !== 0) {\n\t\t\tconst flows = [...pendingFlows];\n\t\t\tpendingFlows.length = 0;\n\t\t\tawait run(flows);\n\t\t\tif (countLeft === pendingFlows.length) {\n\t\t\t\t// nothing can be run\n\t\t\t\tjammed = true;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t} finally {\n\t\tconst isChildProcess = env.isOnChildProcess();\n\n\t\tjsonfile.writeFileSync(path.join(threadTempFolder, 'summary.json'), reports);\n\t\tjsonfile.writeFileSync(path.join(threadTempFolder, 'coverages.json'), allCoverages);\n\n\t\t// print when not child process\n\t\t!isChildProcess && print(env);\n\t\tconsole.info((`Process[${processId}] finished`.bold as any).green);\n\n\t\tif (jammed && isChildProcess) {\n\t\t\treturn Promise.reject('jammed');\n\t\t}\n\t}\n};\n"]}