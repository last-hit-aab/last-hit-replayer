{"version":3,"sources":["../lib/replayer/page-controller.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA,kCAAuC;AACvC,0DAA6B;AAG7B,IAAM,sBAAsB,GAAG,UAAO,IAAU;;;;;gBACzC,GAAG,GAAG;oBACX,OAAO,CAAC,GAAG,CACV,mDAAmD,EACnD,WAAW,EACX,aAAa,CACb,CAAC;oBAEF,iBAAiB;oBACjB,CAAC,UAAA,MAAM;wBACN,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC,SAAS,CAAC,SAAS,CAAC,EAAE;4BACjD,OAAO;yBACP;wBACD,IAAM,kBAAkB,GAAG,EAAE,CAAC;wBAC9B,IAAI,SAAS,GAAkB,IAAI,CAAC;wBACpC,IAAM,iBAAiB,GAAG,UAAC,WAAmB;4BAC7C,OAAO,IAAI,OAAO,CAAC,UAAA,OAAO;gCACzB,IAAM,MAAM,GAAG,QAAQ,CAAC,aAAa,CAAC,QAAQ,CAAC,CAAC;gCAChD,IAAM,GAAG,GAAG,MAAM,CAAC,UAAU,CAAC,IAAI,CAAE,CAAC;gCAErC,IAAM,KAAK,GAAG,IAAI,KAAK,EAAE,CAAC;gCAC1B,KAAK,CAAC,WAAW,GAAG,WAAW,CAAC;gCAChC,KAAK,CAAC,MAAM,GAAG;oCACN,IAAA,mBAAK,EAAE,qBAAM,CAAW;oCAChC,MAAM,CAAC,KAAK,GAAG,KAAK,CAAC;oCACrB,MAAM,CAAC,MAAM,GAAG,MAAM,CAAC;oCACvB,GAAG,CAAC,SAAS,GAAG,MAAM,CAAC;oCACvB,GAAG,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAC,EAAE,KAAK,EAAE,MAAM,CAAC,CAAC;oCAClC,GAAG,CAAC,SAAS,CAAC,KAAK,EAAE,CAAC,EAAE,CAAC,EAAE,KAAK,EAAE,MAAM,CAAC,CAAC;oCAC1C,OAAO,CAAC,MAAM,CAAC,SAAS,CAAC,YAAY,EAAE,GAAG,CAAC,CAAC,CAAC;gCAC9C,CAAC,CAAC;gCACF,KAAK,CAAC,GAAG,GAAG,WAAW,CAAC;4BACzB,CAAC,CAAC,CAAC;wBACJ,CAAC,CAAC;wBACF,MAAM,CAAC,cAAc,GAAG;4BACvB,MAAM,EAAE,UAAC,KAAK,EAAE,IAAI,EAAE,IAAI;gCACzB,6BAA6B;gCAC7B,QAAQ,KAAK,EAAE;oCACd,KAAK,gBAAgB,CAAC;oCACtB,KAAK,eAAe;wCACnB,OAAO,CAAC,GAAG,CAAC,oBAAoB,EAAE,WAAW,EAAE,IAAI,CAAC,CAAC;wCACrD,kBAAkB,CAAC,KAAK,CAAC,GAAG,IAAI,CAAC;wCACjC,kBAAkB,CAAC,KAAK,CAAC,CAAC,SAAS,GAAG,IAAI,CAAC;wCAC3C,MAAM;oCACP,KAAK,gBAAgB;wCACpB,IAAI,CAAC,EAAE,CAAC,CAAC;wCACT,MAAM;oCACP,KAAK,aAAa;wCACjB,IAAM,OAAK,GAAG,QAAQ,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC;wCAC9C,OAAK,CAAC,YAAY,CAAC,MAAM,EAAE,MAAM,CAAC,CAAC;wCACnC,OAAK,CAAC,KAAK,CAAC,UAAU,GAAG,QAAQ,CAAC;wCAClC,OAAK,CAAC,QAAQ,GAAG,UAAA,GAAG;4CACnB,IAAM,IAAI,GAAG,OAAK,CAAC,KAAM,CAAC,CAAC,CAAC,CAAC;4CAC7B,IAAM,MAAM,GAAG,IAAI,UAAU,EAAE,CAAC;4CAChC,MAAM,CAAC,MAAM,GAAG,UAAA,GAAG;gDAClB,IAAM,WAAW,GAAG,GAAG,CAAC,MAAO,CAAC,MAAM,CAAC;gDACvC,IACC,OAAO,WAAW,KAAK,QAAQ;oDAC/B,WAAW,CAAC,UAAU,CAAC,iBAAiB,CAAC,EACxC;oDACD,eAAe;oDACf,iBAAiB,CAAC,WAAW,CAAC,CAAC,IAAI,CAAC,UAAA,WAAW;wDAC9C,SAAS,GAAG,WAAW,CAAC;wDACxB,IAAI,CAAC,EAAE,QAAQ,EAAE,CAAC,CAAC,CAAC,EAAE,MAAM,EAAE,gBAAgB,EAAE,CAAC,CAAC;oDACnD,CAAC,CAAC,CAAC;iDACH;qDAAM;oDACN,SAAS,GAAG,WAAqB,CAAC;oDAClC,IAAI,CAAC,EAAE,QAAQ,EAAE,CAAC,CAAC,CAAC,EAAE,MAAM,EAAE,gBAAgB,EAAE,CAAC,CAAC;iDAClD;4CACF,CAAC,CAAC;4CACF,MAAM,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC;wCAC5B,CAAC,CAAC;wCACF,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,OAAK,CAAC,CAAC;wCAC5B,iDAAiD;wCACjD,iBAAiB;wCACjB,MAAM;oCACP,KAAK,iBAAiB;wCACrB,IAAI,CAAC,EAAE,SAAS,EAAE,SAAS,EAAE,MAAM,EAAE,oBAAoB,EAAE,CAAC,CAAC;wCAC7D,MAAM;iCACP;gCACD,mCAAmC;4BACpC,CAAC;4BACD,EAAE,EAAE,UAAC,KAAK,EAAE,IAAI;gCACf,IAAI,CAAC,EAAE,CAAC,CAAC;4BACV,CAAC;yBACD,CAAC;wBACF,MAAM,CAAC,gBAAgB,CAAC,kBAAkB,EAAE,UAAA,KAAK;4BAChD,IAAI,QAAQ,CAAC,cAAc,CAAC,eAAe,CAAC,IAAI,IAAI,EAAE;gCACrD,OAAO;6BACP;4BACD,IAAM,GAAG,GAAG,QAAQ,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;4BAC1C,GAAG,CAAC,EAAE,GAAG,eAAe,CAAC;4BACzB,GAAG,CAAC,KAAK,CAAC,QAAQ,GAAG,OAAO,CAAC;4BAC7B,GAAG,CAAC,KAAK,CAAC,OAAO,GAAG,MAAM,CAAC;4BAC3B,GAAG,CAAC,KAAK,CAAC,GAAG,GAAG,GAAG,CAAC;4BACpB,GAAG,CAAC,KAAK,CAAC,KAAK,GAAG,GAAG,CAAC;4BACtB,GAAG,CAAC,KAAK,CAAC,eAAe,GAAG,aAAa,CAAC;4BAC1C,GAAG,CAAC,KAAK,CAAC,MAAM,GAAG,QAAQ,CAAC;4BAC5B,IAAM,IAAI,GAAG,QAAQ,CAAC,aAAa,CAAC,MAAM,CAAC,CAAC;4BAC5C,IAAI,CAAC,EAAE,GAAG,uBAAuB,CAAC;4BAClC,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,MAAM,CAAC;4BAC3B,IAAI,CAAC,KAAK,CAAC,KAAK,GAAG,MAAM,CAAC;4BAC1B,uCAAuC;4BACvC,IAAI,CAAC,KAAK,CAAC,eAAe,GAAG,WAAW,CAAC;4BACzC,IAAI,CAAC,KAAK,CAAC,OAAO,GAAG,KAAK,CAAC;4BAC3B,IAAI,CAAC,KAAK,CAAC,YAAY,GAAG,MAAM,CAAC;4BACjC,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,KAAK,CAAC;4BAC1B,IAAI,CAAC,KAAK,CAAC,SAAS,GAAG,YAAY,CAAC;4BACpC,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,SAAS,CAAC;4BAC9B,IAAI,CAAC,KAAK,CAAC,UAAU,GAAG,MAAM,CAAC;4BAC/B,IAAI,CAAC,KAAK,CAAC,UAAU,GAAG,MAAM,CAAC;4BAC/B,IAAI,CAAC,KAAK,CAAC,QAAQ,GAAG,MAAM,CAAC;4BAC7B,IAAI,CAAC,KAAK,CAAC,KAAK,GAAG,MAAM,CAAC;4BAC1B,uCAAuC;4BACvC,IAAM,QAAQ,GAAG,QAAQ,CAAC,aAAa,CAAC,MAAM,CAAC,CAAC;4BAChD,QAAQ,CAAC,WAAW,GAAG,OAAO,CAAC;4BAC/B,QAAQ,CAAC,KAAK,CAAC,UAAU,GAAG,MAAM,CAAC;4BACnC,QAAQ,CAAC,KAAK,CAAC,SAAS,GAAG,YAAY,CAAC;4BACxC,QAAQ,CAAC,KAAK,CAAC,OAAO,GAAG,OAAO,CAAC;4BACjC,QAAQ,CAAC,KAAK,CAAC,eAAe,GAAG,MAAM,CAAC;4BACxC,QAAQ,CAAC,KAAK,CAAC,UAAU,GAAG,QAAQ,CAAC;4BACrC,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;4BACtB,IAAI,CAAC,OAAO,GAAG;gCACd,IAAM,IAAI,GAAG,kBAAkB,CAAC,gBAAgB,CAAC,CAAC;gCAClD,sBAAsB;gCACtB,IAAI,IAAI,IAAI,IAAI,CAAC,IAAI,EAAE;oCACtB,0BAA0B;oCAC1B,OAAO,CAAC,GAAG,CAAC,qBAAmB,IAAI,CAAC,IAAM,EAAE,WAAW,EAAE,aAAa,CAAC,CAAC;oCACxE,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;oCACvB,IAAI,CAAC,SAAS,IAAI,IAAI,CAAC,SAAS,CAAC,EAAE,MAAM,EAAE,mBAAmB,EAAE,CAAC,CAAC;iCAClE;qCAAM;oCACN,kBAAkB;oCAClB,OAAO,CAAC,GAAG,CAAC,qBAAmB,QAAQ,CAAC,IAAM,EAAE,WAAW,EAAE,aAAa,CAAC,CAAC;oCAC5E,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;iCAC3B;4BACF,CAAC,CAAC;4BACF,GAAG,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;4BACjB,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;wBAC3B,CAAC,CAAC,CAAC;oBACJ,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC;oBAEX,OAAO,CAAC,GAAG,CAAC,iDAAiD,EAAE,WAAW,EAAE,aAAa,CAAC,CAAC;gBAC5F,CAAC,CAAC;gBACF,+FAA+F;gBAC/F,oFAAoF;gBACpF,2FAA2F;gBAC3F,qBAAM,IAAI,CAAC,qBAAqB,CAAC,GAAG,CAAC,EAAA;;gBAHrC,+FAA+F;gBAC/F,oFAAoF;gBACpF,2FAA2F;gBAC3F,SAAqC,CAAC;gBACtC,qBAAM,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAA;;gBAAxB,SAAwB,CAAC;;;;KACzB,CAAC;AAEW,QAAA,WAAW,GAAG,UAAO,QAAkB,EAAE,IAAU,EAAE,MAAc,EAAE,IAAY;;;;oBAC7F,qBAAM,sBAAsB,CAAC,IAAI,CAAC,EAAA;;gBAAlC,SAAkC,CAAC;gBACnC,qBAAM,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,EAAA;;gBAA1B,SAA0B,CAAC;gBAC3B,qBAAM,IAAI,CAAC,YAAY,CAAC,QAAQ,CAAC,EAAA;;gBAAjC,SAAiC,CAAC;gBAC5B,aAAa,GAAG;oBACrB,OAAA,CAAC,QAAQ,CAAC,eAAe,CAAC,KAAK,CAAC,eAAe,GAAG,oBAAoB,CAAC;gBAAvE,CAAuE,CAAC;gBACzE,qBAAM,IAAI,CAAC,QAAQ,CAAC,aAAa,CAAC,EAAA;;gBAAlC,SAAkC,CAAC;gBACnC,qBAAM,IAAI,CAAC,cAAc,CAAC,YAAY,EAAE,cAAM,OAAA,IAAI,EAAJ,CAAI,CAAC,EAAA;;gBAAnD,SAAmD,CAAC;gBACrC,qBAAM,IAAI,CAAC,MAAM,EAAE,CAAC,gBAAgB,EAAE,EAAA;;gBAA/C,MAAM,GAAG,SAAsC;qBACjD,MAAM,CAAC,QAAQ,CAAC,QAAQ,EAAxB,wBAAwB;gBAC3B,qBAAM,MAAM,CAAC,IAAI,CAAC,oCAAoC,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC,EAAA;;gBAA1E,SAA0E,CAAC;;oBAK5E,qBAAM,MAAM,CAAC,MAAM,EAAE,EAAA;;gBAArB,SAAqB,CAAC;gBAEtB,qBAAM,mBAAE,CAAC,aAAa,CAAC,IAAI,CAAC,EAAA;;gBAA5B,SAA4B,CAAC;gBAE7B,IAAI,CAAC,EAAE,CAAC,MAAM,EAAE;;;;gCACf,IAAI,QAAQ,CAAC,UAAU,EAAE,EAAE;oCAC1B,4BAA4B;oCAC5B,sBAAO;iCACP;gCACD,qBAAM,IAAI,CAAC,QAAQ,CAAC,aAAa,CAAC,EAAA;;gCAAlC,SAAkC,CAAC;;;;qBACnC,CAAC,CAAC;gBACH,IAAI,CAAC,EAAE,CAAC,OAAO,EAAE;;wBAChB,IAAI,QAAQ,CAAC,UAAU,EAAE,EAAE;4BAC1B,4BAA4B;4BAC5B,sBAAO;yBACP;wBACD,QAAQ,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;;;qBAC1B,CAAC,CAAC;gBAEH,wCAAwC;gBACxC,IAAI,CAAC,EAAE,CAAC,OAAO,EAAE,UAAO,OAAa;;;;;gCACpC,IAAI,QAAQ,CAAC,UAAU,EAAE,EAAE;oCAC1B,4BAA4B;oCAC5B,sBAAO;iCACP;gCACK,MAAM,GAAG,mBAAW,CAAC,OAAO,CAAC,GAAG,EAAE,CAAC,CAAC;gCAEpC,KAAK,GAAG,QAAQ,CAAC,QAAQ,EAAE,CAAC;gCAC5B,YAAY,GAAG,QAAQ,CAAC,eAAe,EAAE,CAAC;gCAC1C,WAAW,GAAG,KAAK,CAAC,YAAY,CAAC,CAAC;gCAElC,cAAc,GAAG,KAAK;qCAC1B,MAAM,CAAC,UAAC,IAAI,EAAE,KAAK,IAAK,OAAA,KAAK,IAAI,YAAY,EAArB,CAAqB,CAAC;qCAC9C,IAAI,CAAC,UAAA,IAAI;oCACT,OAAO,CACN,IAAI,CAAC,IAAI,KAAK,cAAc;wCAC5B,CAAE,IAAwB,CAAC,WAAW,KAAK,WAAW,CAAC,QAAQ;4CAC9D,MAAM,KAAK,mBAAW,CAAE,IAAwB,CAAC,GAAI,CAAC,CAAC,CACxD,CAAC;gCACH,CAAC,CAAC,CAAC;gCACJ,IAAI,cAAc,IAAI,IAAI,EAAE;oCAC3B,QAAQ;yCACN,SAAS,EAAE;yCACX,KAAK,CACL,IAAI,KAAK,CACR,6EAA6E,CAC7E,CACD,CAAC;oCACH,sBAAO;iCACP;gCAED,QAAQ,CAAC,OAAO,CAAC,cAAc,CAAC,IAAI,EAAE,OAAO,EAAE,IAAI,CAAC,CAAC;gCACrD,qBAAM,mBAAW,CAAC,QAAQ,EAAE,OAAO,EAAE,MAAM,EAAE,cAAc,CAAC,IAAI,CAAC,EAAA;;gCAAjE,SAAiE,CAAC;;;;qBAClE,CAAC,CAAC;gBACH,IAAI,CAAC,EAAE,CAAC,QAAQ,EAAE,UAAM,MAAM;;;;;gCAC7B,IAAI,QAAQ,CAAC,UAAU,EAAE,EAAE;oCAC1B,4BAA4B;oCAC5B,sBAAO;iCACP;gCACK,UAAU,GAAG,MAAM,CAAC,IAAI,EAAE,CAAC;qCAC7B,CAAA,UAAU,KAAK,OAAO,CAAA,EAAtB,wBAAsB;gCACzB,yCAAyC;gCACzC,qBAAM,MAAM,CAAC,MAAM,CAAC,SAAS,CAAC,EAAA;;gCAD9B,yCAAyC;gCACzC,SAA8B,CAAC;;;gCACzB,IAAI,CAAC,SAAS,EAAE,QAAQ,CAAC,CAAC,QAAQ,CAAC,UAAU,CAAC,EAAE;oCAChD,iBAAe,QAAQ,CAAC,eAAe,EAAE,CAAC;oCAC1C,KAAK,GAAG,QAAQ,CAAC,QAAQ,EAAE,CAAC;oCAC5B,SAAO,QAAQ,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;oCAE/B,IAAI,GAAG,KAAK;yCAChB,MAAM,CAAC,UAAC,IAAI,EAAE,KAAK,IAAK,OAAA,KAAK,GAAG,cAAY,EAApB,CAAoB,CAAC;yCAC7C,MAAM,CAAC,UAAA,IAAI,IAAI,OAAA,IAAI,CAAC,IAAI,KAAK,cAAc,EAA5B,CAA4B,CAAC;yCAC5C,IAAI,CAAC,UAAA,IAAI,IAAI,OAAA,IAAI,CAAC,IAAI,KAAK,MAAI,EAAlB,CAAkB,CAAC,CAAC;oCACnC,IAAI,IAAI,IAAI,IAAI,EAAE;wCACjB,MAAM,IAAI,KAAK,CACd,wDAAqD,UAAU,wCAAoC,CACnG,CAAC;qCACF;oCACK,eAAe,GAAG,IAAuB,CAAC;oCAChD,IAAI,eAAe,CAAC,MAAM,KAAK,UAAU,EAAE;wCAC1C,MAAM,IAAI,KAAK,CACd,2CAAwC,UAAU,qBAAc,eAAe,CAAC,MAAM,mCAA+B,CACrH,CAAC;qCACF;oCACK,WAAW,GAAG,eAAe,CAAC,WAAW,CAAC;oCAChD,IAAI,OAAO,WAAW,KAAK,QAAQ,EAAE;wCACpC,qCAAqC;wCACrC,MAAM,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC;qCAC3B;yCAAM,IAAI,WAAW,EAAE;wCACvB,sCAAsC;wCACtC,MAAM,CAAC,MAAM,EAAE,CAAC;qCAChB;yCAAM;wCACN,qDAAqD;wCACrD,MAAM,CAAC,OAAO,EAAE,CAAC;qCACjB;iCACD;qCAAM,IAAI,cAAc,KAAK,UAAU,EAAE;oCACnC,iBAAe,QAAQ,CAAC,eAAe,EAAE,CAAC;oCAC1C,KAAK,GAAG,QAAQ,CAAC,QAAQ,EAAE,CAAC;oCAC5B,SAAO,QAAQ,CAAC,QAAQ,CAAC,IAAI,CAAC,CAAC;oCAC/B,QAAQ,GAAG,KAAK;yCACpB,MAAM,CAAC,UAAC,IAAI,EAAE,KAAK,IAAK,OAAA,KAAK,GAAG,cAAY,EAApB,CAAoB,CAAC;wCAC9C,iBAAiB;yCAChB,MAAM,CAAC,UAAA,IAAI,IAAI,OAAA,IAAI,CAAC,IAAI,KAAK,MAAI,EAAlB,CAAkB,CAAC;wCACnC,yDAAyD;yCACxD,MAAM,CAAC,UAAA,IAAI,IAAI,OAAA,IAAI,CAAC,IAAI,KAAK,QAAQ,EAAtB,CAAsB,CAAC;wCACvC,iEAAiE;yCAChE,IAAI,CAAC,UAAC,IAAI,EAAE,KAAK,IAAK,OAAA,KAAK,KAAK,CAAC,EAAX,CAAW,CAAC,CAAC;oCACrC,IAAI,QAAQ,IAAI,IAAI,EAAE;wCACrB,MAAM,IAAI,KAAK,CACd,gDAA6C,UAAU,wCAAoC,CAC3F,CAAC;qCACF;oCACD,IAAI,QAAQ,CAAC,IAAI,KAAK,aAAa,IAAI,QAAQ,CAAC,IAAI,KAAK,eAAe,EAAE;wCACzE,kCAAkC;wCAClC,MAAM,CAAC,MAAM,EAAE,CAAC;qCAChB;yCAAM;wCACN,kCAAkC;wCAClC,MAAM,CAAC,OAAO,EAAE,CAAC;qCACjB;iCACD;;;;;qBACD,CAAC,CAAC;gBACH,IAAI,CAAC,EAAE,CAAC,SAAS,EAAE,UAAA,OAAO;oBACzB,IAAI,QAAQ,CAAC,UAAU,EAAE,EAAE;wBAC1B,4BAA4B;wBAC5B,OAAO;qBACP;oBACD,QAAQ,CAAC,UAAU,CAAC,QAAQ,CAAC,QAAQ,CAAC,IAAI,CAAE,EAAE,OAAO,CAAC,CAAC;gBACxD,CAAC,CAAC,CAAC;gBACH,IAAI,CAAC,EAAE,CAAC,iBAAiB,EAAE,UAAA,OAAO;oBACjC,IAAI,QAAQ,CAAC,UAAU,EAAE,EAAE;wBAC1B,4BAA4B;wBAC5B,OAAO;qBACP;oBACD,QAAQ,CAAC,aAAa,CAAC,QAAQ,CAAC,QAAQ,CAAC,IAAI,CAAE,EAAE,OAAO,EAAE,IAAI,CAAC,CAAC;gBACjE,CAAC,CAAC,CAAC;gBACH,IAAI,CAAC,EAAE,CAAC,eAAe,EAAE,UAAA,OAAO;oBAC/B,IAAI,QAAQ,CAAC,UAAU,EAAE,EAAE;wBAC1B,4BAA4B;wBAC5B,OAAO;qBACP;oBACD,QAAQ,CAAC,aAAa,CAAC,QAAQ,CAAC,QAAQ,CAAC,IAAI,CAAE,EAAE,OAAO,EAAE,KAAK,CAAC,CAAC;gBAClE,CAAC,CAAC,CAAC;;;;KACH,CAAC","file":"page-controller.js","sourcesContent":["import { Device, PageCreatedStep, DialogCloseStep } from 'last-hit-types';\nimport { Page } from 'puppeteer';\nimport { shorternUrl } from '../utils';\nimport ci from './ci-helper';\nimport Replayer from './replayer';\n\nconst installListenersOnPage = async (page: Page) => {\n\tconst god = () => {\n\t\tconsole.log(\n\t\t\t'%c last-hit: %c evaluate on new document start...',\n\t\t\t'color:red',\n\t\t\t'color:brown'\n\t\t);\n\n\t\t// wechat related\n\t\t(window => {\n\t\t\tif (!/MicroMessenger/i.test(navigator.userAgent)) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst WeixinJSBridgeData = {};\n\t\t\tlet imageData: string | null = null;\n\t\t\tconst transformPNG2JPEG = (base64Image: string): Promise<string> => {\n\t\t\t\treturn new Promise(resolve => {\n\t\t\t\t\tconst canvas = document.createElement('canvas');\n\t\t\t\t\tconst ctx = canvas.getContext('2d')!;\n\n\t\t\t\t\tconst image = new Image();\n\t\t\t\t\timage.crossOrigin = 'anonymous';\n\t\t\t\t\timage.onload = function() {\n\t\t\t\t\t\tconst { width, height } = image;\n\t\t\t\t\t\tcanvas.width = width;\n\t\t\t\t\t\tcanvas.height = height;\n\t\t\t\t\t\tctx.fillStyle = '#fff';\n\t\t\t\t\t\tctx.fillRect(0, 0, width, height);\n\t\t\t\t\t\tctx.drawImage(image, 0, 0, width, height);\n\t\t\t\t\t\tresolve(canvas.toDataURL('image/jpeg', 1.0));\n\t\t\t\t\t};\n\t\t\t\t\timage.src = base64Image;\n\t\t\t\t});\n\t\t\t};\n\t\t\twindow.WeixinJSBridge = {\n\t\t\t\tinvoke: (event, data, func) => {\n\t\t\t\t\t// console.info(event, data);\n\t\t\t\t\tswitch (event) {\n\t\t\t\t\t\tcase 'sendAppMessage':\n\t\t\t\t\t\tcase 'shareTimeline':\n\t\t\t\t\t\t\tconsole.log('%c Ready for share', 'color:red', data);\n\t\t\t\t\t\t\tWeixinJSBridgeData[event] = data;\n\t\t\t\t\t\t\tWeixinJSBridgeData[event]._callback = func;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 'preVerifyJSAPI':\n\t\t\t\t\t\t\tfunc({});\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 'chooseImage':\n\t\t\t\t\t\t\tconst input = document.createElement('input');\n\t\t\t\t\t\t\tinput.setAttribute('type', 'file');\n\t\t\t\t\t\t\tinput.style.visibility = 'hidden';\n\t\t\t\t\t\t\tinput.onchange = evt => {\n\t\t\t\t\t\t\t\tconst file = input.files![0];\n\t\t\t\t\t\t\t\tconst reader = new FileReader();\n\t\t\t\t\t\t\t\treader.onload = evt => {\n\t\t\t\t\t\t\t\t\tconst base64Image = evt.target!.result;\n\t\t\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t\t\ttypeof base64Image === 'string' &&\n\t\t\t\t\t\t\t\t\t\tbase64Image.startsWith('data:image/png;')\n\t\t\t\t\t\t\t\t\t) {\n\t\t\t\t\t\t\t\t\t\t// 是PNG, 转成JPEG\n\t\t\t\t\t\t\t\t\t\ttransformPNG2JPEG(base64Image).then(base64Image => {\n\t\t\t\t\t\t\t\t\t\t\timageData = base64Image;\n\t\t\t\t\t\t\t\t\t\t\tfunc({ localIds: [0], errMsg: 'chooseImage:ok' });\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\timageData = base64Image as string;\n\t\t\t\t\t\t\t\t\t\tfunc({ localIds: [0], errMsg: 'chooseImage:ok' });\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\treader.readAsDataURL(file);\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tdocument.body.append(input);\n\t\t\t\t\t\t\t// don't click, replayer will invoke change event\n\t\t\t\t\t\t\t// input.click();\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase 'getLocalImgData':\n\t\t\t\t\t\t\tfunc({ localData: imageData, errMsg: 'getLocalImgData:ok' });\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\t// console.log(WeixinJSBridgeData);\n\t\t\t\t},\n\t\t\t\ton: (event, func) => {\n\t\t\t\t\tfunc({});\n\t\t\t\t}\n\t\t\t};\n\t\t\twindow.addEventListener('DOMContentLoaded', event => {\n\t\t\t\tif (document.getElementById('last-hit-bars') != null) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconst div = document.createElement('div');\n\t\t\t\tdiv.id = 'last-hit-bars';\n\t\t\t\tdiv.style.position = 'fixed';\n\t\t\t\tdiv.style.display = 'flex';\n\t\t\t\tdiv.style.top = '0';\n\t\t\t\tdiv.style.right = '0';\n\t\t\t\tdiv.style.backgroundColor = 'transparent';\n\t\t\t\tdiv.style.zIndex = '100000';\n\t\t\t\tconst span = document.createElement('span');\n\t\t\t\tspan.id = 'last-hit-wechat-share';\n\t\t\t\tspan.style.height = '24px';\n\t\t\t\tspan.style.width = '24px';\n\t\t\t\t// span.style.border = '1px solid red';\n\t\t\t\tspan.style.backgroundColor = 'burlywood';\n\t\t\t\tspan.style.opacity = '0.7';\n\t\t\t\tspan.style.borderRadius = '100%';\n\t\t\t\tspan.style.margin = '3px';\n\t\t\t\tspan.style.boxSizing = 'border-box';\n\t\t\t\tspan.style.cursor = 'pointer';\n\t\t\t\tspan.style.fontWeight = 'bold';\n\t\t\t\tspan.style.lineHeight = '24px';\n\t\t\t\tspan.style.fontSize = '12px';\n\t\t\t\tspan.style.color = '#fff';\n\t\t\t\t// span.style.transform = 'scale(0.8)';\n\t\t\t\tconst textSpan = document.createElement('span');\n\t\t\t\ttextSpan.textContent = 'Share';\n\t\t\t\ttextSpan.style.lineHeight = '24px';\n\t\t\t\ttextSpan.style.transform = 'scale(0.7)';\n\t\t\t\ttextSpan.style.display = 'block';\n\t\t\t\ttextSpan.style.transformOrigin = 'left';\n\t\t\t\ttextSpan.style.whiteSpace = 'nowrap';\n\t\t\t\tspan.append(textSpan);\n\t\t\t\tspan.onclick = () => {\n\t\t\t\t\tconst data = WeixinJSBridgeData['sendAppMessage'];\n\t\t\t\t\t// console.info(data);\n\t\t\t\t\tif (data && data.link) {\n\t\t\t\t\t\t// use prepared share data\n\t\t\t\t\t\tconsole.log(`%c Share to: %c ${data.link}`, 'color:red', 'color:brown');\n\t\t\t\t\t\twindow.open(data.link);\n\t\t\t\t\t\tdata._callback && data._callback({ errMsg: 'sendAppMessage:ok' });\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// use current url\n\t\t\t\t\t\tconsole.log(`%c Share to: %c ${location.href}`, 'color:red', 'color:brown');\n\t\t\t\t\t\twindow.open(location.href);\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\tdiv.append(span);\n\t\t\t\tdocument.body.append(div);\n\t\t\t});\n\t\t})(window);\n\n\t\tconsole.log('%c last-hit: %c evaluate on new document end...', 'color:red', 'color:brown');\n\t};\n\t// some pages postpones the page created or popup event. so evaluateOnNewDocument doesn't work.\n\t// in this case, run evaluate for ensuring the god logic should be install into page\n\t// anyway, monitors cannot be installed twice, so add varaiable $lhGod on window to prevent\n\tawait page.evaluateOnNewDocument(god);\n\tawait page.evaluate(god);\n};\n\nexport const controlPage = async (replayer: Replayer, page: Page, device: Device, uuid: string) => {\n\tawait installListenersOnPage(page);\n\tawait page.emulate(device);\n\tawait page.emulateMedia('screen');\n\tconst setBackground = () =>\n\t\t(document.documentElement.style.backgroundColor = 'rgba(25,25,25,0.8)');\n\tawait page.evaluate(setBackground);\n\tawait page.exposeFunction('$lhGetUuid', () => uuid);\n\tconst client = await page.target().createCDPSession();\n\tif (device.viewport.isMobile) {\n\t\tawait client.send('Emulation.setFocusEmulationEnabled', { enabled: true });\n\t\t// refer to puppeteer.js\n\t\t// await client.send('Emulation.setEmitTouchEventsForMouse', { enabled: true, configuration: 'mobile' });\n\t\t// await client.send('Emulation.setTouchEmulationEnabled', { enabled: true, maxTouchPoints: 1 });\n\t}\n\tawait client.detach();\n\n\tawait ci.startCoverage(page);\n\n\tpage.on('load', async () => {\n\t\tif (replayer.isOnRecord()) {\n\t\t\t// do nothing when on record\n\t\t\treturn;\n\t\t}\n\t\tawait page.evaluate(setBackground);\n\t});\n\tpage.on('close', async () => {\n\t\tif (replayer.isOnRecord()) {\n\t\t\t// do nothing when on record\n\t\t\treturn;\n\t\t}\n\t\treplayer.removePage(page);\n\t});\n\n\t// page created by window.open or anchor\n\tpage.on('popup', async (newPage: Page) => {\n\t\tif (replayer.isOnRecord()) {\n\t\t\t// do nothing when on record\n\t\t\treturn;\n\t\t}\n\t\tconst newUrl = shorternUrl(newPage.url());\n\t\t// find steps from next step of current step, the closest page-created event\n\t\tconst steps = replayer.getSteps();\n\t\tconst currentIndex = replayer.getCurrentIndex();\n\t\tconst currentStep = steps[currentIndex];\n\t\t// IMPORTANT do not compare url here, since might have random token. only path compare is necessary\n\t\tconst pageCreateStep = steps\n\t\t\t.filter((step, index) => index >= currentIndex)\n\t\t\t.find(step => {\n\t\t\t\treturn (\n\t\t\t\t\tstep.type === 'page-created' &&\n\t\t\t\t\t((step as PageCreatedStep).forStepUuid === currentStep.stepUuid ||\n\t\t\t\t\t\tnewUrl === shorternUrl((step as PageCreatedStep).url!))\n\t\t\t\t);\n\t\t\t});\n\t\tif (pageCreateStep == null) {\n\t\t\treplayer\n\t\t\t\t.getLogger()\n\t\t\t\t.error(\n\t\t\t\t\tnew Error(\n\t\t\t\t\t\t'Cannot find page created step for current popup, flow is broken for replay.'\n\t\t\t\t\t)\n\t\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\treplayer.putPage(pageCreateStep.uuid, newPage, true);\n\t\tawait controlPage(replayer, newPage, device, pageCreateStep.uuid);\n\t});\n\tpage.on('dialog', async dialog => {\n\t\tif (replayer.isOnRecord()) {\n\t\t\t// do nothing when on record\n\t\t\treturn;\n\t\t}\n\t\tconst dialogType = dialog.type();\n\t\tif (dialogType === 'alert') {\n\t\t\t// accept is the only way to alert dialog\n\t\t\tawait dialog.accept('success');\n\t\t} else if (['confirm', 'prompt'].includes(dialogType)) {\n\t\t\tconst currentIndex = replayer.getCurrentIndex();\n\t\t\tconst steps = replayer.getSteps();\n\t\t\tconst uuid = replayer.findUuid(page);\n\t\t\t// find the first dialog close step, it must be confirm step\n\t\t\tconst step = steps\n\t\t\t\t.filter((step, index) => index > currentIndex)\n\t\t\t\t.filter(step => step.type === 'dialog-close')\n\t\t\t\t.find(step => step.uuid === uuid);\n\t\t\tif (step == null) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t`Cannot find dialog close step for current dialog \"${dialogType}\" open, flow is broken for replay.`\n\t\t\t\t);\n\t\t\t}\n\t\t\tconst dialogCloseStep = step as DialogCloseStep;\n\t\t\tif (dialogCloseStep.dialog !== dialogType) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t`Cannot match dialog type, should be \"${dialogType}\", but is \"${dialogCloseStep.dialog}\", flow is broken for replay.`\n\t\t\t\t);\n\t\t\t}\n\t\t\tconst returnValue = dialogCloseStep.returnValue;\n\t\t\tif (typeof returnValue === 'string') {\n\t\t\t\t// handle click yes for prompt dialog\n\t\t\t\tdialog.accept(returnValue);\n\t\t\t} else if (returnValue) {\n\t\t\t\t// handle click yes for confirm dialog\n\t\t\t\tdialog.accept();\n\t\t\t} else {\n\t\t\t\t// handle click no for both confirm and prompt dialog\n\t\t\t\tdialog.dismiss();\n\t\t\t}\n\t\t} else if ('beforeunload' === dialogType) {\n\t\t\tconst currentIndex = replayer.getCurrentIndex();\n\t\t\tconst steps = replayer.getSteps();\n\t\t\tconst uuid = replayer.findUuid(page);\n\t\t\tconst nextStep = steps\n\t\t\t\t.filter((step, index) => index > currentIndex)\n\t\t\t\t// must same uuid\n\t\t\t\t.filter(step => step.uuid === uuid)\n\t\t\t\t// unload is not captured, but must be filtered, 20191006\n\t\t\t\t.filter(step => step.type !== 'unload')\n\t\t\t\t// the first step which with same page uuid and isn't unload step\n\t\t\t\t.find((step, index) => index === 0);\n\t\t\tif (nextStep == null) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t`Cannot find next step for current dialog \"${dialogType}\" open, flow is broken for replay.`\n\t\t\t\t);\n\t\t\t}\n\t\t\tif (nextStep.type === 'page-closed' || nextStep.type === 'page-switched') {\n\t\t\t\t// seems unload had been performed\n\t\t\t\tdialog.accept();\n\t\t\t} else {\n\t\t\t\t// seems unload had been cancelled\n\t\t\t\tdialog.dismiss();\n\t\t\t}\n\t\t}\n\t});\n\tpage.on('request', request => {\n\t\tif (replayer.isOnRecord()) {\n\t\t\t// do nothing when on record\n\t\t\treturn;\n\t\t}\n\t\treplayer.putRequest(replayer.findUuid(page)!, request);\n\t});\n\tpage.on('requestfinished', request => {\n\t\tif (replayer.isOnRecord()) {\n\t\t\t// do nothing when on record\n\t\t\treturn;\n\t\t}\n\t\treplayer.offsetRequest(replayer.findUuid(page)!, request, true);\n\t});\n\tpage.on('requestfailed', request => {\n\t\tif (replayer.isOnRecord()) {\n\t\t\t// do nothing when on record\n\t\t\treturn;\n\t\t}\n\t\treplayer.offsetRequest(replayer.findUuid(page)!, request, false);\n\t});\n};\n"]}