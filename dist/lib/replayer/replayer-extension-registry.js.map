{"version":3,"sources":["../lib/replayer/replayer-extension-registry.ts"],"names":[],"mappings":"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","file":"replayer-extension-registry.js","sourcesContent":["import {\n\tExtensionDataTransmittedEvent,\n\tExtensionErrorLogEvent,\n\tExtensionEventTypes,\n\tExtensionLogEvent,\n\tExtensionPoint,\n\tExtensionRegisteredEvent,\n\tExtensionRegistry,\n\tExtensionUnregisteredEvent,\n\tGenericEventHandler\n} from 'last-hit-extensions';\nimport { Environment as Env, Flow, Step, WorkspaceExtensions } from 'last-hit-types';\nimport path from 'path';\nimport uuidv4 from 'uuid/v4';\nimport Environment from '../config/env';\n\nconst DEFAULT_EVENT_HANDLER_TIMEOUT = 3000;\nconst asStory = (storyName: string): WorkspaceExtensions.SimpleStory => {\n\treturn {\n\t\tname: storyName,\n\t\tdescription: ''\n\t};\n};\n\nexport class WorkspaceExtensionRegistry extends ExtensionRegistry {\n\tprivate workspaceExtensionId: string;\n\tprivate workspaceExtensionFolder: string;\n\tprivate env: Environment;\n\n\tconstructor(options: { env: Environment }) {\n\t\tsuper();\n\n\t\tconst { env } = options;\n\t\tthis.workspaceExtensionId = uuidv4();\n\t\tthis.workspaceExtensionFolder = path.join(env.getWorkspace(), '.scripts');\n\t\tthis.env = env;\n\t}\n\tgetWorkspaceExtensionId(): string {\n\t\treturn this.workspaceExtensionId;\n\t}\n\tgetWorkspaceExtensionFolder(): string {\n\t\treturn this.workspaceExtensionFolder;\n\t}\n\tgetEnvironment(): Environment {\n\t\treturn this.env;\n\t}\n\tsendWorkspaceEvent<T extends WorkspaceExtensions.ReturnedData>(\n\t\tevent: WorkspaceExtensions.WorkspaceEvent\n\t): Promise<{\n\t\tignored: boolean;\n\t\ttimeout?: true;\n\t\terror?: Error;\n\t\tdata?: T;\n\t}> {\n\t\treturn new Promise(resolve => {\n\t\t\tthis.once(\n\t\t\t\tExtensionEventTypes.DATA_TRANSMITTED,\n\t\t\t\t(evt: ExtensionDataTransmittedEvent): void => {\n\t\t\t\t\tconst { data } = evt;\n\t\t\t\t\tif (data.ignore) {\n\t\t\t\t\t\t// ignore event, do nothing\n\t\t\t\t\t\t// console.log(`[${event.type}] is ignored by workspace extension scripts`);\n\t\t\t\t\t\tresolve({ ignored: true });\n\t\t\t\t\t} else if (data.error) {\n\t\t\t\t\t\t// error occurred\n\t\t\t\t\t\t// console.error(\n\t\t\t\t\t\t// \t`error occurred on [${event.type}] via workspace extension scripts, ignored`\n\t\t\t\t\t\t// );\n\t\t\t\t\t\t// console.error(data.error);\n\t\t\t\t\t\tresolve({ ignored: false, error: data.error });\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// console.log(\n\t\t\t\t\t\t// \t`data returned on [${event.type}] from workspace extension scripts`,\n\t\t\t\t\t\t// \tdata\n\t\t\t\t\t\t// );\n\t\t\t\t\t\t// merge\n\t\t\t\t\t\tresolve({ ignored: false, data: data as T });\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tDEFAULT_EVENT_HANDLER_TIMEOUT,\n\t\t\t\t() => {\n\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t`Timeout on [${event.type}] via workspace extension scripts, ignored`\n\t\t\t\t\t);\n\t\t\t\t\tresolve({ ignored: true, timeout: true });\n\t\t\t\t}\n\t\t\t);\n\t\t\tthis.sendMessage(this.getWorkspaceExtensionId(), event);\n\t\t});\n\t}\n\t/**\n\t * quick send step-should-start to extension,\n\t * return data when success, otherwise return nothing(void)\n\t */\n\tasync quickSendWorkspaceEvent<T extends WorkspaceExtensions.ReturnedData>(\n\t\teventType: WorkspaceExtensions.WorkspaceEventTypes,\n\t\tdata: object\n\t): Promise<T | null> {\n\t\tconst result = await this.sendWorkspaceEvent<T>({\n\t\t\ttype: eventType,\n\t\t\t...data\n\t\t} as WorkspaceExtensions.StepShouldStartEvent);\n\t\tif (!result.ignored) {\n\t\t\tif (result.error) {\n\t\t\t\t// error thrown from extension\n\t\t\t\tthrow result.error;\n\t\t\t} else {\n\t\t\t\t// everything is ok\n\t\t\t\treturn result.data!;\n\t\t\t}\n\t\t} else {\n\t\t\t// extension returns ignored or extension timeout\n\t\t\treturn null;\n\t\t}\n\t}\n\t/**\n\t * send step-accomplished to extension, return data when success\n\t */\n\tasync stepAccomplished(\n\t\tstoryName: string,\n\t\tflow: Flow,\n\t\tstep: Step\n\t): Promise<WorkspaceExtensions.AccomplishedStep> {\n\t\treturn (\n\t\t\t(await this.quickSendWorkspaceEvent('step-accomplished', {\n\t\t\t\tstory: asStory(storyName),\n\t\t\t\tflow,\n\t\t\t\tstep\n\t\t\t})) || { ...step, _: { passed: true } }\n\t\t);\n\t}\n\t/**\n\t * send step-accomplished to extension, return data when success\n\t */\n\tasync stepOnError(\n\t\tstoryName: string,\n\t\tflow: Flow,\n\t\tstep: Step,\n\t\terror: Error\n\t): Promise<WorkspaceExtensions.FixedStep> {\n\t\treturn (\n\t\t\t(await this.quickSendWorkspaceEvent('step-on-error', {\n\t\t\t\tstory: asStory(storyName),\n\t\t\t\tflow,\n\t\t\t\tstep,\n\t\t\t\terror: {\n\t\t\t\t\tname: error.name,\n\t\t\t\t\tmessage: error.message,\n\t\t\t\t\tstack: error.stack\n\t\t\t\t}\n\t\t\t})) || { ...step, _: { fixed: false } }\n\t\t);\n\t}\n\t/**\n\t * send step-should-start to extension, return data when success\n\t */\n\tasync stepShouldStart(\n\t\tstoryName: string,\n\t\tflow: Flow,\n\t\tstep: Step\n\t): Promise<WorkspaceExtensions.PreparedStep> {\n\t\treturn (\n\t\t\t(await this.quickSendWorkspaceEvent('step-should-start', {\n\t\t\t\tstory: asStory(storyName),\n\t\t\t\tflow,\n\t\t\t\tstep\n\t\t\t})) || step\n\t\t);\n\t}\n\t/**\n\t * send flow-accomplished to extension, return data when success\n\t */\n\tasync flowAccomplished(\n\t\tstoryName: string,\n\t\tflow: Flow\n\t): Promise<WorkspaceExtensions.AccomplishedFlow | null> {\n\t\treturn await this.quickSendWorkspaceEvent('flow-accomplished', {\n\t\t\tstory: asStory(storyName),\n\t\t\tflow\n\t\t});\n\t}\n\t/**\n\t * send flow-should-start to extension, return data when success\n\t */\n\tasync flowShouldStart(\n\t\tstoryName: string,\n\t\tflow: Flow\n\t): Promise<WorkspaceExtensions.PreparedFlow | null> {\n\t\treturn await this.quickSendWorkspaceEvent('flow-should-start', {\n\t\t\tstory: asStory(storyName),\n\t\t\tflow\n\t\t});\n\t}\n\t/**\n\t * send story-prepare to extension, return data anyway\n\t */\n\tasync prepareStory(storyName: string): Promise<WorkspaceExtensions.PreparedStory> {\n\t\tconst story = asStory(storyName);\n\t\tconst data = await this.quickSendWorkspaceEvent<WorkspaceExtensions.PreparedStory>(\n\t\t\t'story-prepare',\n\t\t\t{\n\t\t\t\tstory\n\t\t\t}\n\t\t);\n\t\treturn data || story;\n\t}\n\tonce(\n\t\tevent: ExtensionEventTypes,\n\t\thandler: GenericEventHandler,\n\t\ttimeout?: number,\n\t\tonTimeout?: () => void\n\t): this {\n\t\tlet timeoutHanlder;\n\t\tsuper.once(event, (...args: Array<any>) => {\n\t\t\tif (timeoutHanlder) {\n\t\t\t\tclearTimeout(timeoutHanlder);\n\t\t\t}\n\t\t\thandler(...args);\n\t\t});\n\t\tif (onTimeout) {\n\t\t\ttimeoutHanlder = setTimeout(() => {\n\t\t\t\tthis.off(event, handler);\n\t\t\t\tonTimeout();\n\t\t\t}, timeout);\n\t\t}\n\t\treturn this;\n\t}\n\tasync launch(): Promise<void> {\n\t\treturn new Promise(async (resolve, reject) => {\n\t\t\tconst onRegistered = async (event: ExtensionRegisteredEvent) => {\n\t\t\t\toff();\n\t\t\t\tconst { error } = event;\n\t\t\t\tif (error) {\n\t\t\t\t\t// register failed\n\t\t\t\t\tconsole.log('register failed', error);\n\t\t\t\t\tresolve();\n\t\t\t\t} else {\n\t\t\t\t\t// register successfully\n\t\t\t\t\tthis.once(\n\t\t\t\t\t\tExtensionEventTypes.DATA_TRANSMITTED,\n\t\t\t\t\t\t(event: ExtensionDataTransmittedEvent): void => {\n\t\t\t\t\t\t\tconst { data } = event;\n\t\t\t\t\t\t\tif (data.ignore) {\n\t\t\t\t\t\t\t\t// ignore event, do nothing\n\t\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t\t'environment prepare is ignored by workspace extension scripts'\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\tresolve();\n\t\t\t\t\t\t\t} else if (data.error) {\n\t\t\t\t\t\t\t\t// error occurred\n\t\t\t\t\t\t\t\tconsole.error(\n\t\t\t\t\t\t\t\t\t'error occurred on environment prepare via workspace extension scripts, ignored'\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\tconsole.error(data.error);\n\t\t\t\t\t\t\t\tresolve();\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t\t'data returned on environment prepare from workspace extension scripts',\n\t\t\t\t\t\t\t\t\tdata\n\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t// merge\n\t\t\t\t\t\t\t\tthis.getEnvironment().mergeFrom(data);\n\t\t\t\t\t\t\t\tresolve();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\tDEFAULT_EVENT_HANDLER_TIMEOUT,\n\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t'Timeout on environment prepare via workspace extension scripts, ignored'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tresolve();\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\t\t\t\t\tthis.sendMessage(this.getWorkspaceExtensionId(), {\n\t\t\t\t\t\ttype: 'env-prepare',\n\t\t\t\t\t\tenv: this.getEnvironment().expose() as Env\n\t\t\t\t\t} as WorkspaceExtensions.EnvironmentPrepareEvent);\n\t\t\t\t}\n\t\t\t};\n\t\t\tconst onUnregistered = (event: ExtensionUnregisteredEvent) => {\n\t\t\t\toff();\n\t\t\t\tresolve();\n\t\t\t};\n\t\t\tconst onLog = (event: ExtensionLogEvent) => {\n\t\t\t\tconsole.log('log on extension register');\n\t\t\t\tconsole.log(event);\n\t\t\t};\n\t\t\tconst onErrorLog = (event: ExtensionErrorLogEvent) => {\n\t\t\t\tconsole.error('error occurred on extension register');\n\t\t\t\tconsole.error(event);\n\t\t\t};\n\t\t\tthis.once(ExtensionEventTypes.REGISTERED, onRegistered)\n\t\t\t\t.once(ExtensionEventTypes.UNREGISTERED, onUnregistered)\n\t\t\t\t.on(ExtensionEventTypes.LOG, onLog)\n\t\t\t\t.on(ExtensionEventTypes.ERROR_LOG, onErrorLog);\n\n\t\t\tconst off = () => {\n\t\t\t\tthis.off(ExtensionEventTypes.REGISTERED, onRegistered)\n\t\t\t\t\t.off(ExtensionEventTypes.UNREGISTERED, onUnregistered)\n\t\t\t\t\t.off(ExtensionEventTypes.LOG, onLog)\n\t\t\t\t\t.off(ExtensionEventTypes.ERROR_LOG, onErrorLog);\n\t\t\t};\n\t\t\tawait this.startupExtension(\n\t\t\t\tnew ExtensionPoint({\n\t\t\t\t\tid: this.getWorkspaceExtensionId(),\n\t\t\t\t\tname: 'temp-workspace-extension',\n\t\t\t\t\tdescription: '',\n\t\t\t\t\tfolder: this.getWorkspaceExtensionFolder()\n\t\t\t\t})\n\t\t\t);\n\t\t});\n\t}\n}\n"]}